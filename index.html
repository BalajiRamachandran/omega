<!DOCTYPE html>
<html>
<head>
<title>Ω</title>
<style type="text/css">
	body {
		margin: 3em;
	}
	#messages {
		width: 100%;
		border: 1px solid grey;
		height: 20em;
		list-style-type: none;
		padding: 0.3em;
	}
	#form {
		width: 100%;
	}
	#input {
		width: 100%;
	}
	#header h1 {
		display: inline;
		margin: 0;
	}
	#loggedInUser {
		float: right;
		line-height: 3em;
	}
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.js"></script>
<script src="http://127.0.0.1:1337/socket.io/socket.io.js"></script>
<script src="js/jquery.tmpl.js"></script>
<script src="js/knockout-1.2.1.js"></script>
<script src="js/underscore-1.1.7.js"></script>
</head>
<body>
<div id="header">
	<h1>Ω</h1><div id="loggedInUser" data-bind="text: user().name"></div>
</div>
<ul id="messages" data-bind="template: {name: 'messageItemTemplate', foreach: messages}">
</ul>
<form id="form" action="">
	<input id="input" type="text" name="text" placeholder="Type commands or just chat it up"/>
</form>

<script type="text/x-jquery-tmpl" id="messageItemTemplate">
	<li>{{= $item.data}}</li>
</script>

<script type="text/javascript">
var socket = new io.Socket("127.0.0.1:1337");
socket.connect();

socket.on("connect", function () {
	console.log("socket connected");
});

/* global $, ko, socket */
var OmegaIssueTracker = {};
(function (OIT) {
	function mapRange (num, istart, istop, ostart, ostop) {
		return ostart + Math.round((ostop - ostart) * ((num - istart) / (istop - istart)));
	}
	
	var sampleUser = {
		id: 1,
		name: 'wachunga',
		getColour: function () {
			var hexes = _.map(this.name.split(''), function (c) {
				var mapped = Math.abs(mapRange(c.charCodeAt(0), 33, 128, 0, 255));
				return mapped.toString(16).substr(0,2);
			});
			while (hexes.length < 3) {
				hexes.push("00");
			}
			return '#' + hexes.slice(0,3).join('');
		}
	};
	
	OIT.Tracker = function ($inputBox, $form) {
		this.$inputBox = $inputBox;
		$inputBox.focus();
		
		this.user = ko.observable(sampleUser);
		
		this.messages = ko.observableArray();
		this.issues = ko.observableArray();
		ko.applyBindings(this);
		
		var that = this;
		$form.submit(function(e) {
			e.preventDefault();
			that.handleInput();
		});
	};
	
	OIT.Tracker.prototype.handleInput = function () {
		var input = this.$inputBox.val();
		this.$inputBox.val("");
		// check for invalid commands etc
		this.send(input);
	};
	
	OIT.Tracker.prototype.send = function (message) {
		var msg = { command: message };
		console.log("sending", msg, JSON.stringify(msg), socket);
		socket.send(JSON.stringify(msg.command));
	};
	
	OIT.Tracker.prototype.handleMessage = function (data) {
		var msg = JSON.parse(data);
		console.log("socket message received", data, msg);
		this.messages.push(msg);
		//var objDiv = document.getElementById('msgs');
		//objDiv.scrollTop = objDiv.scrollHeight;
	};
}(OmegaIssueTracker));

$(function () {
	var tracker = new OmegaIssueTracker.Tracker($("#input"), $("#form"));
	
	socket.on('message', function (data) {
		tracker.handleMessage(data);
	});
});
</script>
</body>
</html>
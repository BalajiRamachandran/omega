<!DOCTYPE html>
<html>
<head>
<title>Ω</title>
<style type="text/css">
	body {
		margin: 3em;
	}
	#messages {
		width: 100%;
		border: 1px solid grey;
		height: 20em;
		list-style-type: none;
		padding: 0.3em;
	}
	#issues {
		list-style-type: none;
		padding: 0.3em;
	}
	#form {
		width: 100%;
	}
	#input {
		width: 100%;
	}
	#header h1 {
		display: inline;
		margin: 0;
	}
	#loggedInUser {
		float: right;
		line-height: 3em;
	}
	
	.closed {
		background-color: grey;
	}
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="js/jquery.tmpl.js"></script>
<script src="js/knockout-1.2.1.js"></script>
<script src="js/underscore-1.1.7.js"></script>
</head>
<body>
<div id="header">
	<h1>Ω</h1><div id="loggedInUser" data-bind="text: user().name"></div>
</div>
<ul id="messages" data-bind="template: {name: 'messageItemTemplate', foreach: messages}">
</ul>
<form id="form" action="">
	<input id="input" type="text" name="text" placeholder="Type commands or just chat it up"/>
</form>
<ul id="issues" data-bind="template: {name: 'issueItemTemplate', foreach: issues}">
</ul>

<script type="text/x-jquery-tmpl" id="messageItemTemplate">
	<li>{{= user}} says: {{= msg}}</li>
</script>
<script type="text/x-jquery-tmpl" id="issueItemTemplate">
	<li data-bind="css: { closed: closed }">Ω{{= id}} {{= description}}</li>
</script>

<script type="text/javascript">
var socket = io.connect();

socket.on("connect", function () {
	console.log("socket connected");
});

/* global $, ko, socket */
var OmegaIssueTracker = {};
(function (OIT) {
	function mapRange (num, istart, istop, ostart, ostop) {
		return ostart + Math.round((ostop - ostart) * ((num - istart) / (istop - istart)));
	}
	
	var sampleUser = {
		id: 1,
		name: window.location.hash.substring(1) || "anonymous",
		getColour: function () {
			var hexes = _.map(this.name.split(''), function (c) {
				var mapped = Math.abs(mapRange(c.charCodeAt(0), 33, 128, 0, 255));
				return mapped.toString(16).substr(0,2);
			});
			while (hexes.length < 3) {
				hexes.push("00");
			}
			return '#' + hexes.slice(0,3).join('');
		}
	};
	
	OIT.Tracker = function ($inputBox, $form, socket) {
		this.$inputBox = $inputBox;
		$inputBox.focus();
		
		this.user = ko.observable(sampleUser);
		
		this.messages = ko.observableArray();
		this.issues = ko.observableArray();
		ko.applyBindings(this);
		
		var that = this;
		$form.submit(function(e) {
			e.preventDefault();
			that.handleInput();
		});
		
		this.socket = socket;
		socket.emit('nickname', sampleUser.name, function (alreadyTaken) {
			if (alreadyTaken) {
				throw "That nickname is taken.";
			}
		});
		
		this.socket.on('issues', function (issues) {
			_.each(issues, function (issue) {
				issue.closed = ko.observable(issue.closed);
			});
			that.issues(issues);
		});
		
		this.socket.on('user message', function (user, msg) {
			console.log("um", user, msg);
			that.handleMessage(user, msg);
		});
		
		this.socket.on('announcement', function (msg) {
			console.log("ann", msg);
			that.handleMessage("Ω", msg);
		});	
		
		this.socket.on('issue created', function (issue) {
			that.handleMessage("Ω", issue.creator + " created " + issue.id + ".");
			issue.closed = ko.observable(issue.closed);
			that.issues.push(issue);
		});	
		
		this.socket.on('issue closed', function (closer, id) {
			that.handleMessage("Ω", closer + " closed " + id + ".");
			var issue = _.find(that.issues(), function (issue) {
				return issue.id === id;
			});
			issue.closed(true);
		});	
		
	};
	
	OIT.Tracker.prototype.handleInput = function () {
		var input = this.$inputBox.val();
		this.$inputBox.val("");
		// check for invalid commands etc
		if (!input || input.length < 1) {
			return;
		}
			
		// check for command
		if (input.charAt(0) === ":") {
			var cmd = input.substring(1).split(" ")[0];
			var rest = input.substring(2 + cmd.length);
			switch (cmd) {
				case "create":
				case "nouveau":
				case "new":
				case "open":
					this.createIssue(rest);
					break;
				case "close":
				case "resolve":
				case "resolved":
					this.closeIssue(parseInt(rest));
					break;
				default:
					break;
			}
		} else {
			this.send(input);
		}
	};
	
	OIT.Tracker.prototype.createIssue = function (desc) {
		socket.emit("new issue", desc);
	};
	
	OIT.Tracker.prototype.closeIssue = function (id) {
		socket.emit("close issue", id);
	};
	
	OIT.Tracker.prototype.send = function (message) {
		var msg = { command: message };
		console.log("sending", msg);
		socket.emit("user message", message);
	};
	
	OIT.Tracker.prototype.handleMessage = function (user, msg) {
		//console.log("socket message received", user, msg);
		this.messages.push({user: user, msg: msg});
		//var objDiv = document.getElementById('msgs');
		//objDiv.scrollTop = objDiv.scrollHeight;
	};
}(OmegaIssueTracker));

var tracker;
$(function () {
	tracker = new OmegaIssueTracker.Tracker($("#input"), $("#form"), socket);
});
</script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<title>Omega Issue Tracker</title>
	<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans" type="text/css">
	<link rel="stylesheet" href="css/omega.css" type="text/css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script src="js/jquery.tmpl.js"></script>
	<script src="js/knockout-1.2.1.js"></script>
	<script src="js/underscore-1.1.7.js"></script>
	<script src="js/omega.js"></script>
	<script src="js/util.js"></script>
	<script src="js/jquery.timeago.js"></script>
</head>
<body>
<div id="header">
	<h1>Ω</h1><div id="loggedInUser" data-bind="visible: !!user()"><span data-bind="html: 'welcome, <strong>' + user() + '</strong>'"></span> | <span class="notificationToggle" data-bind="text: webNotifyEnabled() ? '⚑' : '⚐', click: requestNotificationPermission, attr: { title: webNotifyEnabled() ? 'Web notifications are enabled' : 'Web notifications are disabled' }"></span> | <a href="#" data-bind="click: logout">kthxbye</a></div>
</div>
<ul id="messages" data-bind="template: {name: 'messageItemTemplate', foreach: messages, beforeRemove: function(elem) { $(elem).fadeOut() }, afterAdd: function(elem) { $(elem).hide().fadeIn('fast') }}">
</ul>
<div id="onlineUsers">
	online: <span data-bind="template: { name: 'onlineUsersTemplate', foreach: onlineUsers }"></span><span data-bind="visible: !onlineUsers().length" class="subtle">nobody</span>
</div>
<h3 class="warningMessage loud" data-bind="visible: disconnected()">Warning: disconnected from server. Attempting to reconnect...</h3>
<form id="form" autocomplete="off" data-bind="visible: !disconnected()">
	<label data-bind="visible: !user()">You're not signed in. Who are you? <input id="nameInput" type="text" data-bind="attr: { placeholder: namePlaceholder }" /></label>
	<span class="invalidName loud" data-bind="fadeVisible: !user() && invalidName()">I don't think so. Try again.</span>
	<input id="messageInput" type="text" data-bind="visible: user()" tabindex="1" placeholder="Type commands (like '/help') or just chat it up"/>
	<input type="submit" />
</form>
<dl id="commandList" data-bind="fadeVisible: helpOpen, click: function() { helpOpen(false); $messageInput.focus(); }">
	<dt>/create &lt;description&gt;</dt>
	<dt>/critical &lt;id&gt;</dt>
	<dt>/assign &lt;id&gt; [&lt;user&gt;]</dt>
	<dt>/unassign &lt;id&gt;</dt>
	<dt>/edit &lt;id&gt; &lt;description&gt;</dt>
	<dt>/close &lt;id&gt;</dt>
	<dt>/reopen &lt;id&gt;</dt>
	<dt>/reset</dt>
</dl>

<div id="issuesContainer">
	<label class="hideIssues"><input type="checkbox" data-bind="checked: hideClosed"/> hide closed</label>
	<label class="hideIssues"><input type="checkbox" data-bind="checked: hideAssigned"/> hide assigned</label>
	<h2>Issues <span data-bind="fadeVisible: issues().length >= 3" class="issueCounts subtle">(<var data-bind="text: openIssuesCount"></var> open, <var data-bind="text: issues().length - openIssuesCount()"></var> closed)</span></h2>
	<p class="noneMessage subtle" data-bind="fadeVisible: !issues().length || (hideClosed() && openIssuesCount() == 0)">No open issues. w00t!</p>
	<ul class="issuesList" data-bind="template: {name: 'issueItemTemplate', foreach: sortedIssues, templateOptions: { user: user, hideClosed: hideClosed, hideAssigned: hideAssigned, highlightedIssue: highlightedIssue }, afterRender: applyTimeago }">
	</ul>
</div>
<div class="footer subtle">Powered by node.js. <a href="https://github.com/Wachunga/Omega-Issue-Tracker">Hosted</a> on GitHub. <span data-bind="template: 'versionTemplate'"></span></div>

<script type="text/x-jquery-tmpl" id="onlineUsersTemplate">
	<span class="onlineUser">{{if count > 1}}{{= name }} <span class="subtle">({{= count}})</span>{{else}}{{= name}}{{/if}}</span>
</script>
<script type="text/x-jquery-tmpl" id="messageItemTemplate">
	<li data-bind="css: {system: !user}"><span class="speaker" data-bind="text: user ? user + ': ' : ''"></span><span data-bind="html: addHtmlLinks(msg)"></span></li>
</script>
<script type="text/x-jquery-tmpl" id="issueItemTemplate">
	<li id="{{= id}}" data-bind="fadeVisible: !($item.hideClosed() && closed()) && !($item.hideAssigned() && assignee() != 'nobody'), css: { closed: closed, highlighted: id === $item.highlightedIssue() }"><a href="#{{= id}}" title="Permalink" class="issueId">{{= id}}</a>:&nbsp;<span class="loud" data-bind="text: critical() ? '★ ' : ''"></span>
		<span class="assignee" data-bind="css: { myself: $item.user() && assignee().toLowerCase() === $item.user().toLowerCase() }, text: assignee().toLowerCase() !== 'nobody' ? '(@' + assignee() + ')' : ''"></span>
		&nbsp;<span class="description" data-bind="html: addHtmlLinks(escapeHtml(description))"></span>
		&nbsp;<span class="details subtle">(created by {{= creator}} <time datetime="{{= createdDate}}"></time>)</span>
	</li>
</script>
<script type="text/x-jquery-tmpl" id="versionTemplate">
	<span data-bind="fadeVisible: !!version()">Version <a href="https://github.com/Wachunga/Omega-Issue-Tracker/commit/{{= version}}">{{= shortVersion}}</a>.</span>
</script>

<script type="text/javascript">
var socket = io.connect();

var tracker; // for debugging
$(function () {
	if (!isLocalStorageSupported) {
		alert("Your browser is very out of date. To use Ω, please use a newer browser.");
		return;
	}
	tracker = new OmegaIssueTracker.Tracker($("#messages"), $("#nameInput"), $("#messageInput"), $("#form"), socket);
});
</script>
</body>
</html>

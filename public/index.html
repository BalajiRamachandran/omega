<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<title>Ω: Omega Issue Tracker</title>
	<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans" type="text/css">
	<link rel="stylesheet" href="css/omega.css" type="text/css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script src="js/jquery.tmpl.js"></script>
	<script src="js/knockout-1.2.1.js"></script>
	<script src="js/underscore-1.1.7.js"></script>
	<script src="js/omega.js"></script>
</head>
<body>
<div id="header">
	<h1>Ω</h1><div id="loggedInUser" data-bind="text: 'welcome, ' + user()"></div>
</div>
<ul id="messages" data-bind="template: {name: 'messageItemTemplate', foreach: messages, beforeRemove: function(elem) { $(elem).fadeOut() }, afterAdd: function(elem) { $(elem).hide().fadeIn('fast') }}">
</ul>
<div id="onlineUsers">
	online: <span data-bind="text: onlineUsers().join(', ')"></span>
</div>
<form id="form" autocomplete="off">
	<input id="input" type="text" name="text" tabindex="1" placeholder="Type commands (like '/help') or just chat it up"/>
</form>
<dl id="commandList" data-bind="fadeVisible: helpOpen, click: function() { helpOpen(false); $inputBox.focus(); }">
	<dt>/create &lt;description&gt;</dt>
	<dt>/assign &lt;id&gt; [&lt;user&gt;]</dt>
	<dt>/unassign &lt;id&gt;</dt>
	<dt>/edit &lt;id&gt; &lt;description&gt;</dt>
	<dt>/close &lt;id&gt;</dt>
</dl>

<div id="issuesContainer">
	<label class="hideIssues"><input type="checkbox" data-bind="checked: hideClosed"/> hide closed</label>
	<h2>Issues <span data-bind="fadeVisible: issues().length >= 3" class="issueCounts">(<var data-bind="text: openIssuesCount"></var> open, <var data-bind="text: issues().length - openIssuesCount()"></var> closed)</span></h2>
	<ul id="issuesList" data-bind="template: {name: 'issueItemTemplate', foreach: issues, templateOptions: { hideClosed: hideClosed }, beforeRemove: function(elem) { $(elem).fadeOut() }, afterAdd: function(elem) { $(elem).hide().fadeIn('slow') }}">
	</ul>
</div>

<script type="text/x-jquery-tmpl" id="messageItemTemplate">
	<li data-bind="css: {system: !user}"><span class="speaker" data-bind="text: user ? user + ': ' : ''"></span>{{= msg}}</li>
</script>
<script type="text/x-jquery-tmpl" id="issueItemTemplate">
	<li data-bind="fadeVisible: !($item.hideClosed() && closed()), css: { closed: closed }">{{= id}}: <span class="assignee" data-bind="text: assignee() != 'nobody' ? '(@' + assignee() + ')' : ''"></span> {{= description}}</li>
</script>

<script type="text/javascript">
var socket = io.connect();

var tracker; // for debugging
$(function () {
	tracker = new OmegaIssueTracker.Tracker($("#messages"), $("#input"), $("#form"), socket);
});

ko.bindingHandlers.fadeVisible = {
	init: function(element, valueAccessor) {
		var value = valueAccessor();
		$(element).toggle(ko.utils.unwrapObservable(value));
	},
	update: function(element, valueAccessor) {
		var value = valueAccessor();
		ko.utils.unwrapObservable(value) ? $(element).fadeIn('fast') : $(element).fadeOut('fast');
	}
};
</script>
</body>
</html>
